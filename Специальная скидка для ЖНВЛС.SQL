-- Специальная скидка для ДК, накопительный дисконт на все кроме товаров ЖНВЛС более 500р
-- http://samson.protek.ru:8080/issues/4382
IF (OBJECT_ID('USP_DISCOUNT2_GET_ZH') IS NULL)
    EXEC('CREATE PROCEDURE USP_DISCOUNT2_GET_ZH AS RETURN')
GO
ALTER PROCEDURE USP_DISCOUNT2_GET_ZH
    @VALUE_IN VARCHAR(4000)
AS
    SELECT 
        VALUE = CONVERT(VARCHAR(4000), GOODS.IMPORTANT)
    FROM GOODS
    WHERE EXISTS (SELECT NULL
            FROM LOT
            WHERE LOT.ID_GOODS = GOODS.ID_GOODS
            AND LOT.ID_LOT_GLOBAL = CONVERT(UNIQUEIDENTIFIER, @VALUE_IN))
RETURN
GO

IF (OBJECT_ID('USP_DISCOUNT2_GET_ZHLT500') IS NULL)
    EXEC('CREATE PROCEDURE USP_DISCOUNT2_GET_ZHLT500 AS RETURN')
GO
ALTER PROCEDURE USP_DISCOUNT2_GET_ZHLT500
    @VALUE_IN VARCHAR(4000)
AS
    SELECT 
        VALUE = CONVERT(VARCHAR(4000), CONVERT(BIT, 1))
    FROM LOT
    WHERE LOT.ID_LOT_GLOBAL=CONVERT(UNIQUEIDENTIFIER, @VALUE_IN)
    AND EXISTS (SELECT NULL FROM GOODS WHERE GOODS.ID_GOODS = LOT.ID_GOODS AND GOODS.IMPORTANT=1)
    AND LOT.PRICE_SAL<500
RETURN
GO
