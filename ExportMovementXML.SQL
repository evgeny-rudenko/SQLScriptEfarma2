USE [farma]
GO
/****** Object:  StoredProcedure [dbo].[USP_EXPORT_MOVEMENT_2_XML]    Script Date: 13.01.2019 11:42:29 ******/
--
--Выгрузка перемещения с остатками 18% НДС
--Для загрузки уже с 20% НДС
--
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[USP_EXPORT_MOVEMENT_2_XML]
    @ID_GLOBAL UNIQUEIDENTIFIER 
AS
    DECLARE @DOC TABLE(
        FID BIGINT NOT NULL PRIMARY KEY IDENTITY,
        DOC_NAME VARCHAR(300),
        ID_SUPPLIER BIGINT
    )
    
    DECLARE @HEADER TABLE(
        SID BIGINT NOT NULL PRIMARY KEY IDENTITY,
        FID BIGINT NOT NULL,

        SUPPLIER_NAME VARCHAR(300),
        SVAT_SUPPLIER MONEY,
        SUM_SUPPLIER MONEY,
        SVAT_RETAIL MONEY,
        SUM_RETAIL MONEY,
        INCOMING_NUMBER VARCHAR(300),
        INCOMING_DATE DATETIME,
        INCOMING_BILL_NUMBER VARCHAR(300),
        INCOMING_BILL_DATE DATETIME,
        COMMENT VARCHAR(300)
    )

    DECLARE @ITEM TABLE(
        TID BIGINT NOT NULL PRIMARY KEY IDENTITY,
        SID BIGINT NOT NULL,
        FID BIGINT NOT NULL,

        NUMERATOR INT, 
        DENOMINATOR INT,
        UNIT_NAME VARCHAR(300),
        
        GOODS_CODE VARCHAR(300),
        GOODS VARCHAR(300),
        PRODUCER VARCHAR(300),
        COUNTRY VARCHAR(300), 
        IMPORTANT BIT,
        REGISTER_PRICE MONEY,
        REGISTRATION_DATE DATETIME,
        
        QUANTITY MONEY,
        PRODUCER_PRICE MONEY,
        
        SUPPLIER_VAT_PER_UNIT MONEY,
        SUPPLIER_ADPRICE MONEY,
        SUPPLIER_PRICE MONEY,
        SUPPLIER_VAT MONEY,
        SUPPLIER_PRICE_VAT MONEY,
        SUPPLIER_SUM MONEY,
        SUPPLIER_VAT_SUM MONEY,
        SUPPLIER_SUM_VAT MONEY,
        
        RETAIL_ADPRICE MONEY,
        RETAIL_PRICE MONEY,
        RETAIL_VAT MONEY,
        RETAIL_PRICE_VAT MONEY,
        RETAIL_SUM MONEY,
        RETAIL_VAT_SUM MONEY,
        RETAIL_SUM_VAT MONEY,
        
        SERIES_NUMBER VARCHAR(300),
        BEST_BEFORE DATETIME,
        GTD_NUMBER VARCHAR(300),
        BAR_CODE VARCHAR(300),

        ID_SERIES BIGINT
    )

    DECLARE @CERT TABLE(
        TID BIGINT NOT NULL,
        SID BIGINT NOT NULL,
        FID BIGINT NOT NULL,

        CERT_NUMBER VARCHAR(300),
        CERT_ORGAN VARCHAR(300),
        CERT_DATE DATETIME, 
        CERT_END_DATE DATETIME
    )

    INSERT INTO @DOC(
        DOC_NAME,
        ID_SUPPLIER
    )
    SELECT DISTINCT 
        M.MNEMOCODE+'_'+dbo.FN_DATE_2_VARCHAR(M.DATE),
        C.ID_CONTRACTOR 
    FROM MOVEMENT M
    INNER JOIN LOT L ON L.ID_DOCUMENT = M.ID_MOVEMENT_GLOBAL
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = L.ID_SUPPLIER 
    WHERE ID_MOVEMENT_GLOBAL = @ID_GLOBAL
--     AND EXISTS (SELECT NULL FROM LOT_MOVEMENT LM WHERE LM.ID_LOT_GLOBAL = L.ID_LOT_GLOBAL)
--     AND L.QUANTITY_REM>0

    INSERT INTO @HEADER(
        FID,
        SUPPLIER_NAME,
        SVAT_SUPPLIER,
        SUM_SUPPLIER,
        SVAT_RETAIL,
        SUM_RETAIL,
        INCOMING_NUMBER,
        INCOMING_DATE,
        INCOMING_BILL_NUMBER,
        INCOMING_BILL_DATE,
        COMMENT
    )
    SELECT
        D.FID,
        C.NAME,

        SVAT_SUPPLIER = SUM(L.PVAT_SUP*MI.QUANTITY),
        SUM_SUPPLIER = SUM(L.PRICE_SUP*MI.QUANTITY),
        SVAT_RETAIL = SUM(L.PVAT_SAL*MI.QUANTITY),
        SUM_RETAIL = SUM(L.PRICE_SAL*MI.QUANTITY),
        M.MNEMOCODE,
        M.DATE,
        NULL,
        NULL,
        M.COMMENT
    FROM MOVEMENT M 
    INNER JOIN MOVEMENT_ITEM MI ON MI.ID_MOVEMENT_GLOBAL = M.ID_MOVEMENT_GLOBAL
    INNER JOIN LOT L ON L.ID_DOCUMENT = MI.ID_MOVEMENT_GLOBAL AND L.ID_DOCUMENT_ITEM = MI.ID_MOVEMENT_ITEM_GLOBAL
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = L.ID_SUPPLIER
    INNER JOIN @DOC D ON D.ID_SUPPLIER = L.ID_SUPPLIER
    WHERE M.ID_MOVEMENT_GLOBAL = @ID_GLOBAL
    GROUP BY D.FID,C.NAME,M.MNEMOCODE,M.DATE,M.COMMENT
    

    INSERT INTO @ITEM(
        SID,
        FID,

        NUMERATOR, 
        DENOMINATOR,
        UNIT_NAME,
        
        GOODS_CODE,
        GOODS,
        PRODUCER,
        COUNTRY, 
        IMPORTANT,
        REGISTER_PRICE,
        REGISTRATION_DATE,
        
        QUANTITY,
        PRODUCER_PRICE,
        
        SUPPLIER_VAT_PER_UNIT,
        SUPPLIER_ADPRICE,
        SUPPLIER_PRICE,
        SUPPLIER_VAT,
        SUPPLIER_PRICE_VAT,
        SUPPLIER_SUM,
        SUPPLIER_VAT_SUM,
        SUPPLIER_SUM_VAT,
        
        RETAIL_ADPRICE,
        RETAIL_PRICE,
        RETAIL_VAT,
        RETAIL_PRICE_VAT,
        RETAIL_SUM,
        RETAIL_VAT_SUM,
        RETAIL_SUM_VAT,
        
        SERIES_NUMBER,
        BEST_BEFORE,
        GTD_NUMBER,
        BAR_CODE,

        ID_SERIES
    )
    SELECT
        H.SID,
        H.FID,

        NUMERATOR = SR.NUMERATOR, 
        DENOMINATOR = SR.DENOMINATOR,
        UNIT_NAME = U.SHORT_NAME,
        
        GOODS_CODE = (SELECT TOP 1 CODE FROM GOODS_CODE WHERE ID_CONTRACTOR = L.ID_SUPPLIER AND ID_GOODS = G.ID_GOODS AND GOODS_CODE.DATE_DELETED IS NULL),
        GOODS = G.NAME,
        PRODUCER = P.NAME,
        COUNTRY = C.NAME, 
        IMPORTANT = CONVERT(BIT, G.IMPORTANT),
        REGISTER_PRICE = isnull(a.price, G.REGISTER_PRICE),
        REGISTRATION_DATE = isnull(a.date, G.REGISTRATION_DATE),

        QUANTITY = L.QUANTITY_REM,
        PRODUCER_PRICE = L.PRICE_PROD,
        
        SUPPLIER_VAT_PER_UNIT = ( L.PRICE_SUP*20/120),
        SUPPLIER_ADPRICE = CASE ISNULL(L.PRICE_PROD,0) WHEN 0 THEN NULL ELSE ((L.PRICE_SUP * 100)/L.PRICE_PROD)-100 END,
        SUPPLIER_PRICE = L.PRICE_SUP -( L.PRICE_SUP*20/120),--  L.PVAT_SUP,
        SUPPLIER_VAT = 20,
        SUPPLIER_PRICE_VAT = L.PRICE_SUP,
        SUPPLIER_SUM = (L.PRICE_SUP * MI.QUANTITY) - (( L.PRICE_SUP*20/120) * MI.QUANTITY),
        SUPPLIER_VAT_SUM = ( L.PRICE_SUP*20/120) * MI.QUANTITY,
        SUPPLIER_SUM_VAT = L.PRICE_SUP * MI.QUANTITY,
        
        RETAIL_ADPRICE = CASE ISNULL(L.PRICE_SUP,0) WHEN 0 THEN NULL ELSE ((L.PRICE_SAL * 100)/L.PRICE_SUP)-100 END,
        RETAIL_PRICE = L.PRICE_SAL,
        RETAIL_VAT = 0,
        RETAIL_PRICE_VAT = L.PRICE_SAL,
        RETAIL_SUM = (L.PRICE_SAL * MI.QUANTITY) ,
        RETAIL_VAT_SUM = 0,
        RETAIL_SUM_VAT = L.PRICE_SAL * MI.QUANTITY,
        
        S.SERIES_NUMBER,
        S.BEST_BEFORE,
        NULL,
        L.INTERNAL_BARCODE,

        S.ID_SERIES
    FROM MOVEMENT_ITEM MI
    INNER JOIN LOT L ON L.ID_DOCUMENT = MI.ID_MOVEMENT_GLOBAL AND L.ID_DOCUMENT_ITEM = MI.ID_MOVEMENT_ITEM_GLOBAL
    INNER JOIN GOODS G ON G.ID_GOODS = L.ID_GOODS
    INNER JOIN PRODUCER P ON P.ID_PRODUCER = G.ID_PRODUCER
    INNER JOIN COUNTRY C ON C.ID_COUNTRY = P.ID_COUNTRY
    INNER JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
    INNER JOIN UNIT U ON U.ID_UNIT = SR.ID_UNIT
    LEFT JOIN SERIES S ON S.ID_SERIES = L.ID_SERIES
    INNER JOIN @DOC D ON D.ID_SUPPLIER = L.ID_SUPPLIER
    INNER JOIN @HEADER H ON D.FID = H.FID
    LEFT join dbo.fn_actual_register_price(null) a on a.id_goods_global = G.id_goods_global
    WHERE MI.ID_MOVEMENT_GLOBAL = @ID_GLOBAL
--     AND EXISTS (SELECT NULL FROM LOT_MOVEMENT LM WHERE LM.ID_LOT_GLOBAL = L.ID_LOT_GLOBAL)
--     AND L.QUANTITY_REM>0

    INSERT INTO @CERT(
        TID,
        SID,
        FID,

        CERT_NUMBER,
        CERT_ORGAN,
        CERT_DATE,
        CERT_END_DATE
    )
    SELECT
        I.TID,
        I.SID,
        I.FID,

        CERT_NUMBER,
        ISSUED_BY,
        CERT_DATE,
        CERT_END_DATE
    FROM @ITEM I 
    INNER JOIN CERTIFICATE C ON C.ID_SERIES = I.ID_SERIES
    

    SELECT 
        FID,
        DOC_NAME
    FROM @DOC

    SELECT 
        FID,
        SID,
        SUPPLIER_NAME,
        SVAT_SUPPLIER,
        SUM_SUPPLIER,
        SVAT_RETAIL,
        SUM_RETAIL,
        INCOMING_NUMBER,
        INCOMING_DATE,
        INCOMING_BILL_NUMBER,
        INCOMING_BILL_DATE,
        COMMENT
    FROM @HEADER        

    SELECT
        FID,
        SID,
        TID,

        NUMERATOR, 
        DENOMINATOR,
        UNIT_NAME,
        
        GOODS_CODE,
        GOODS,
        PRODUCER,
        COUNTRY, 
        IMPORTANT,
        REGISTER_PRICE,
        REGISTRATION_DATE,
        
        QUANTITY,
        PRODUCER_PRICE,
        
        SUPPLIER_VAT_PER_UNIT,
        SUPPLIER_ADPRICE,
        SUPPLIER_PRICE,
        SUPPLIER_VAT,
        SUPPLIER_PRICE_VAT,
        SUPPLIER_SUM,
        SUPPLIER_VAT_SUM,
        SUPPLIER_SUM_VAT,
        
        RETAIL_ADPRICE,
        RETAIL_PRICE,
        RETAIL_VAT,
        RETAIL_PRICE_VAT,
        RETAIL_SUM,
        RETAIL_VAT_SUM,
        RETAIL_SUM_VAT,
        
        SERIES_NUMBER,
        BEST_BEFORE,
        GTD_NUMBER,
        BAR_CODE
    FROM @ITEM

    SELECT
        FID,
        SID,
        TID,
        CERT_NUMBER,
        CERT_ORGAN,
        CERT_DATE 
        CERT_END_DATE
    FROM @CERT

RETURN
